# UI Polish Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement remaining UI polish items from the backlog: screenshot aspect ratio fix, virtual scrolling for large lists, and keyboard navigation in screenshot preview.

**Architecture:** These are targeted improvements to existing components. No new major components needed - just enhancing Screenshot component, ImageGallery, and HourGroup.

**Tech Stack:** React 18, TypeScript, TailwindCSS, react-window (for virtual scrolling)

---

## Task 1: Fix Screenshot Aspect Ratio

**Files:**
- Modify: `frontend/src/components/common/Screenshot.tsx`

**Problem:** Screenshots use hardcoded `aspect-video` (16:9) but monitors can have different aspect ratios (16:10, 21:9, etc.)

**Step 1: Update Screenshot component to use dynamic aspect ratio**

In `Screenshot.tsx`, replace the hardcoded `aspect-video` class with inline style using `monitorWidth` and `monitorHeight` from the screenshot data.

Current code (lines 42-45):
```tsx
<Skeleton
  className={cn('aspect-video rounded', sizeClasses[size], className)}
/>
```

New code:
```tsx
const aspectRatio = screenshot.monitorWidth && screenshot.monitorHeight
  ? screenshot.monitorWidth / screenshot.monitorHeight
  : 16/9;

<Skeleton
  className={cn('rounded', sizeClasses[size], className)}
  style={{ aspectRatio }}
/>
```

**Step 2: Update the main container**

Current code (lines 48-56):
```tsx
<div
  className={cn(
    'relative aspect-video rounded overflow-hidden bg-muted cursor-pointer group',
    ...
  )}
>
```

New code:
```tsx
const aspectRatio = screenshot.monitorWidth && screenshot.monitorHeight
  ? screenshot.monitorWidth / screenshot.monitorHeight
  : 16/9;

<div
  className={cn(
    'relative rounded overflow-hidden bg-muted cursor-pointer group',
    ...
  )}
  style={{ aspectRatio }}
>
```

**Step 3: Run dev server and verify**

Run: `wails dev -tags webkit2_41`
Navigate to Screenshots page and verify screenshots display with correct proportions.

**Step 4: Commit**

```bash
git add frontend/src/components/common/Screenshot.tsx
git commit -m "fix(ui): use actual monitor aspect ratio for screenshots

Uses monitorWidth/monitorHeight from screenshot data instead of
hardcoded 16:9 aspect ratio. Falls back to 16:9 if dimensions
are not available."
```

---

## Task 2: Add Keyboard Navigation to ImageGallery

**Files:**
- Modify: `frontend/src/components/common/ImageGallery.tsx`

**Problem:** Users can't navigate screenshots with arrow keys in the preview modal.

**Step 1: Find ImageGallery component**

```bash
cat frontend/src/components/common/ImageGallery.tsx
```

Understand the current structure and how it handles prev/next navigation.

**Step 2: Add useEffect for keyboard listener**

Add keyboard event listener when the gallery is open:

```tsx
import { useEffect } from 'react';

// Inside the component, after existing hooks:
useEffect(() => {
  if (!open) return;

  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      // Call previous handler
      if (currentIndex > 0) {
        onIndexChange?.(currentIndex - 1);
      }
    } else if (e.key === 'ArrowRight') {
      e.preventDefault();
      // Call next handler
      if (currentIndex < screenshots.length - 1) {
        onIndexChange?.(currentIndex + 1);
      }
    } else if (e.key === 'Escape') {
      e.preventDefault();
      onClose?.();
    }
  };

  window.addEventListener('keydown', handleKeyDown);
  return () => window.removeEventListener('keydown', handleKeyDown);
}, [open, currentIndex, screenshots.length, onIndexChange, onClose]);
```

**Step 3: Test keyboard navigation**

Run: `wails dev -tags webkit2_41`
Open Screenshots page, click a screenshot, use arrow keys to navigate.

**Step 4: Commit**

```bash
git add frontend/src/components/common/ImageGallery.tsx
git commit -m "feat(ui): add keyboard navigation to ImageGallery

Left/Right arrows navigate between screenshots.
Escape closes the gallery."
```

---

## Task 3: Virtual Scrolling for Screenshot Grid

**Files:**
- Modify: `frontend/src/components/timeline/HourGroup.tsx`
- Optional: Create `frontend/src/components/common/VirtualGrid.tsx`

**Problem:** Days with 500+ screenshots load all images at once, causing performance issues.

**Step 1: Install react-window**

```bash
cd frontend && npm install react-window @types/react-window
```

**Step 2: Create VirtualGrid component for screenshots**

Create `frontend/src/components/common/VirtualGrid.tsx`:

```tsx
import { FixedSizeGrid as Grid } from 'react-window';
import { useMemo, useCallback } from 'react';
import type { Screenshot as ScreenshotType } from '@/types';
import { Screenshot } from './Screenshot';

interface VirtualGridProps {
  screenshots: ScreenshotType[];
  width: number;
  height: number;
  columnCount: number;
  onScreenshotClick?: (screenshot: ScreenshotType, index: number) => void;
}

export function VirtualGrid({
  screenshots,
  width,
  height,
  columnCount,
  onScreenshotClick,
}: VirtualGridProps) {
  const columnWidth = Math.floor(width / columnCount);
  const rowHeight = Math.floor(columnWidth * (9 / 16)) + 8; // aspect ratio + gap
  const rowCount = Math.ceil(screenshots.length / columnCount);

  const Cell = useCallback(({ columnIndex, rowIndex, style }: any) => {
    const index = rowIndex * columnCount + columnIndex;
    if (index >= screenshots.length) return null;

    const screenshot = screenshots[index];
    return (
      <div style={{ ...style, padding: 4 }}>
        <Screenshot
          screenshot={screenshot}
          size="thumbnail"
          showOverlay={true}
          onClick={() => onScreenshotClick?.(screenshot, index)}
          className="w-full"
        />
      </div>
    );
  }, [screenshots, columnCount, onScreenshotClick]);

  return (
    <Grid
      columnCount={columnCount}
      columnWidth={columnWidth}
      height={height}
      rowCount={rowCount}
      rowHeight={rowHeight}
      width={width}
    >
      {Cell}
    </Grid>
  );
}
```

**Step 3: Use VirtualGrid for large screenshot lists**

In `HourGroup.tsx`, conditionally use VirtualGrid when there are many screenshots:

```tsx
import { VirtualGrid } from '@/components/common/VirtualGrid';

// Inside the component, when rendering screenshots:
const VIRTUALIZATION_THRESHOLD = 50;

{screenshots.length > VIRTUALIZATION_THRESHOLD ? (
  <div className="h-[300px] w-full">
    <VirtualGrid
      screenshots={screenshots}
      width={containerRef.current?.clientWidth || 800}
      height={300}
      columnCount={8}
      onScreenshotClick={(s, i) => onScreenshotClick?.(s, i)}
    />
  </div>
) : (
  // Existing grid render
)}
```

**Step 4: Test with large screenshot day**

Run: `wails dev -tags webkit2_41`
Find a day with many screenshots, verify scrolling is smooth.

**Step 5: Commit**

```bash
git add frontend/src/components/common/VirtualGrid.tsx frontend/src/components/timeline/HourGroup.tsx frontend/package.json frontend/package-lock.json
git commit -m "feat(ui): add virtual scrolling for large screenshot lists

Uses react-window to virtualize screenshot grids with >50 items.
Improves performance on days with 500+ screenshots."
```

---

## Task 4: Manual Testing Checklist

**Files:** None (manual verification)

**Step 1: Start the dev server**

```bash
cd /home/harshad/projects/traq
wails dev -tags webkit2_41
```

**Step 2: Verify aspect ratio fix**

- [ ] Screenshots display with correct proportions
- [ ] Different monitor sizes render correctly
- [ ] Thumbnails maintain proper aspect ratio

**Step 3: Verify keyboard navigation**

- [ ] Left arrow goes to previous screenshot
- [ ] Right arrow goes to next screenshot
- [ ] Escape closes the gallery
- [ ] Navigation wraps correctly at edges (or stops)

**Step 4: Verify virtual scrolling**

- [ ] Find a day with many screenshots
- [ ] Scrolling is smooth
- [ ] Images load as they come into view
- [ ] No visible layout issues

**Step 5: Run tests**

```bash
cd frontend && npm test
```

---

## Task 5: Final Cleanup and Summary

**Step 1: Review commits**

```bash
git log --oneline -10
```

**Step 2: Ensure no console errors**

Open browser dev tools, navigate through Screenshots and Timeline pages, check for errors.

**Step 3: Create summary**

Document what was implemented:
- Screenshot aspect ratio now uses actual monitor dimensions
- Keyboard navigation (Left/Right/Escape) in ImageGallery
- Virtual scrolling for screenshot grids with >50 items
