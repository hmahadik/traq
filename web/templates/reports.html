<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Activity Tracker</title>
    <link rel="stylesheet" href="/static/styles/base.css">
    <script src="/static/js/utils.js"></script>
    <style>
        /* Tag colors */
        :root {
            --tag-coding: #6366f1;
            --tag-research: #f59e0b;
            --tag-communication: #22c55e;
            --tag-meetings: #ec4899;
            --tag-writing: #8b5cf6;
            --tag-terminal: #14b8a6;
            --tag-media: #f43f5e;
            --tag-browsing: #64748b;
            --tag-other: #94a3b8;
            --tag-afk: var(--surface-2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-top: 12px;
        }

        .nav-links a {
            color: var(--muted);
            text-decoration: none;
            font-size: 0.9rem;
            padding: 8px 0;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Hero Section */
        .hero-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .hero-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .granularity-toggle {
            display: flex;
            gap: 4px;
            background: var(--surface-2);
            padding: 4px;
            border-radius: 8px;
        }

        .granularity-toggle button {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 0.875rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .granularity-toggle button.active {
            background: var(--accent);
            color: white;
        }

        .granularity-toggle button:hover:not(.active) {
            background: var(--border);
            color: var(--text);
        }

        .date-navigation {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .date-navigation button {
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .date-navigation button:hover {
            background: var(--border);
        }

        .date-navigation .current-date {
            font-size: 1rem;
            font-weight: 500;
            min-width: 150px;
            text-align: center;
        }

        .hero-actions {
            display: flex;
            gap: 8px;
        }

        .hero-actions button {
            padding: 8px 16px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .hero-actions button:hover {
            background: var(--border);
        }

        .hero-actions .export-btn {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .hero-actions .export-btn:hover {
            background: var(--accent-strong);
        }

        /* Hero Metrics */
        .hero-metrics {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            padding: 20px 0;
        }

        .hero-main-metric {
            text-align: center;
        }

        .hero-main-metric .time-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1;
        }

        .hero-main-metric .time-label {
            font-size: 0.875rem;
            color: var(--muted);
            margin-top: 8px;
        }

        /* Time Breakdown Chart */
        .time-breakdown {
            width: 100%;
            max-width: 500px;
            background: var(--surface-2);
            border-radius: 12px;
            padding: 20px;
        }

        .breakdown-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .breakdown-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .breakdown-bar:last-child {
            margin-bottom: 0;
        }

        .bar-label {
            width: 70px;
            font-size: 0.875rem;
            color: var(--text);
        }

        .bar-track {
            flex: 1;
            height: 24px;
            background: var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .bar-fill.work { background: var(--success); }
        .bar-fill.meetings { background: #ec4899; }
        .bar-fill.breaks { background: var(--muted); }

        .bar-value {
            width: 60px;
            text-align: right;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
        }

        /* Secondary Metrics Row */
        .hero-metrics-row {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .metric-card {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 16px 20px;
            text-align: center;
            min-width: 130px;
        }

        .metric-card .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
        }

        .metric-card .metric-label {
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-card .metric-detail {
            font-size: 0.7rem;
            color: var(--muted-strong);
            margin-top: 2px;
        }

        /* Timeline Section */
        .timeline-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timeline-container {
            position: relative;
            height: 60px;
            background: var(--surface-2);
            border-radius: 8px;
            overflow: hidden;
        }

        .timeline-bar {
            position: absolute;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.2s;
            overflow: hidden;
        }

        .timeline-bar:hover {
            opacity: 0.85;
        }

        .timeline-bar .bar-label {
            font-size: 0.7rem;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 4px;
        }

        .timeline-bar.afk {
            background: repeating-linear-gradient(
                45deg,
                var(--surface-2),
                var(--surface-2) 5px,
                var(--border) 5px,
                var(--border) 10px
            );
        }

        .timeline-hours {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding: 0 4px;
        }

        .timeline-hours span {
            font-size: 0.7rem;
            color: var(--muted);
        }

        .timeline-legend {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--muted);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* Vertical Bar Chart (for week/month/year views) */
        .timeline-container.vertical-bars {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 120px;
            padding: 10px 5px;
            gap: 4px;
        }

        .vertical-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            max-width: 60px;
        }

        .vertical-bar-wrapper {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column-reverse;
            border-radius: 4px 4px 0 0;
            overflow: hidden;
            background: var(--border);
            min-height: 10px;
        }

        .vertical-bar-segment {
            width: 100%;
            transition: height 0.3s ease;
            cursor: pointer;
        }

        .vertical-bar-segment:hover {
            filter: brightness(1.1);
        }

        .vertical-bar.empty {
            width: 100%;
            height: 10%;
            background: repeating-linear-gradient(
                45deg,
                var(--surface-2),
                var(--surface-2) 3px,
                var(--border) 3px,
                var(--border) 6px
            );
            border-radius: 4px 4px 0 0;
        }

        .vertical-bar-label {
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 6px;
            text-align: center;
        }

        .timeline-hint {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 12px;
        }

        /* Tag Breakdown Section */
        .breakdown-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .tag-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .tag-item {
            padding: 16px;
            background: var(--surface-2);
            border-radius: 8px;
        }

        .tag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .tag-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .tag-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .tag-stats {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
        }

        .tag-duration {
            color: var(--text);
            font-weight: 500;
        }

        .tag-percentage {
            color: var(--muted);
        }

        .tag-progress {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .tag-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .tag-windows {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding-left: 18px;
            border-left: 2px solid var(--border);
            margin-left: 4px;
        }

        .window-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .window-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        .window-duration {
            color: var(--muted-strong);
            flex-shrink: 0;
        }

        /* Screenshots Section */
        .screenshots-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .screenshot-grid {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .screenshot-card {
            flex-shrink: 0;
            width: 180px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .screenshot-card:hover {
            transform: translateY(-2px);
        }

        .screenshot-thumb {
            width: 100%;
            height: 100px;
            background: var(--surface-2);
            border-radius: 8px;
            overflow: hidden;
        }

        .screenshot-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .screenshot-meta {
            margin-top: 8px;
        }

        .screenshot-time {
            font-size: 0.8rem;
            color: var(--text);
            font-weight: 500;
        }

        .screenshot-tag {
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 2px;
        }

        .view-all-link {
            color: var(--accent);
            font-size: 0.875rem;
            text-decoration: none;
        }

        .view-all-link:hover {
            text-decoration: underline;
        }

        /* AI Summary Section */
        .summary-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .summary-toggle {
            width: 100%;
            padding: 16px 20px;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-toggle:hover {
            background: var(--surface-2);
        }

        .summary-toggle .toggle-icon {
            transition: transform 0.2s;
        }

        .summary-toggle.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .summary-content {
            display: none;
            padding: 0 20px 20px;
        }

        .summary-content.visible {
            display: block;
        }

        .summary-text {
            color: var(--text);
            line-height: 1.7;
            margin-bottom: 16px;
        }

        .summary-meta {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .confidence-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .confidence-dots {
            display: flex;
            gap: 3px;
        }

        .confidence-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
        }

        .confidence-dot.filled {
            background: var(--success);
        }

        .summary-actions {
            display: flex;
            gap: 8px;
        }

        .summary-actions button {
            padding: 6px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: var(--muted);
            font-size: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .summary-actions button:hover {
            background: var(--border);
            color: var(--text);
        }

        /* Export Dropdown */
        .export-dropdown {
            position: relative;
        }

        .export-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            min-width: 180px;
            display: none;
            z-index: 100;
        }

        .export-menu.visible {
            display: block;
        }

        .export-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            color: var(--text);
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .export-menu-item:hover {
            background: var(--surface-2);
        }

        .export-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .export-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.visible {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--surface-2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .empty-state-hint {
            font-size: 0.875rem;
            color: var(--muted-strong);
        }

        /* Screenshot Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 8px;
        }

        .modal-meta {
            margin-top: 12px;
            color: white;
            text-align: center;
        }

        .modal-close {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: var(--surface);
            border: none;
            border-radius: 50%;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-metrics {
                flex-direction: column;
                gap: 24px;
            }

            .hero-secondary-metrics {
                flex-direction: column;
                width: 100%;
            }

            .secondary-metric {
                width: 100%;
            }

            .hero-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .granularity-toggle {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Activity Tracker</h1>
            <nav class="nav-links">
                <a href="/timeline">Timeline</a>
                <a href="/analytics">Analytics</a>
                <a href="/reports" class="active">Reports</a>
                <a href="/settings">Settings</a>
            </nav>
        </header>

        <!-- Hero Section -->
        <div class="hero-section">
            <div class="hero-controls">
                <div class="granularity-toggle">
                    <button data-granularity="day" class="active">Day</button>
                    <button data-granularity="week">Week</button>
                    <button data-granularity="month">Month</button>
                    <button data-granularity="year">Year</button>
                    <button data-granularity="custom">Custom</button>
                </div>

                <div class="date-navigation">
                    <button id="prevDate" title="Previous">&larr;</button>
                    <span class="current-date" id="currentDate">Loading...</span>
                    <button id="nextDate" title="Next">&rarr;</button>
                </div>

                <div class="hero-actions">
                    <div class="export-dropdown">
                        <button class="export-btn" id="exportBtn">
                            <span>Export</span>
                            <span>&#9662;</span>
                        </button>
                        <div class="export-menu" id="exportMenu">
                            <div class="export-menu-item" data-format="markdown">Markdown</div>
                            <div class="export-menu-item" data-format="html">HTML (Standalone)</div>
                            <div class="export-menu-item" data-format="pdf">PDF</div>
                            <div class="export-menu-item" data-format="json">JSON</div>
                        </div>
                    </div>
                    <button id="settingsBtn" title="Report settings">&#9881;</button>
                </div>
            </div>

            <div class="hero-metrics" id="heroMetrics">
                <div class="hero-main-metric">
                    <div class="time-value" id="totalTime">--:--</div>
                    <div class="time-label" id="totalTimeLabel">Tracked Today</div>
                </div>

                <!-- Time Breakdown Chart -->
                <div class="time-breakdown" id="timeBreakdown">
                    <div class="breakdown-header" id="breakdownHeader">TIME BREAKDOWN</div>
                    <div class="breakdown-bars">
                        <div class="breakdown-bar">
                            <span class="bar-label">Work</span>
                            <div class="bar-track">
                                <div class="bar-fill work" id="workBar"></div>
                            </div>
                            <span class="bar-value" id="workValue">--</span>
                        </div>
                        <div class="breakdown-bar">
                            <span class="bar-label">Meetings</span>
                            <div class="bar-track">
                                <div class="bar-fill meetings" id="meetingsBar"></div>
                            </div>
                            <span class="bar-value" id="meetingsValue">--</span>
                        </div>
                        <div class="breakdown-bar">
                            <span class="bar-label">Breaks</span>
                            <div class="bar-track">
                                <div class="bar-fill breaks" id="breaksBar"></div>
                            </div>
                            <span class="bar-value" id="breaksValue">--</span>
                        </div>
                    </div>
                </div>

                <!-- Secondary Metrics -->
                <div class="hero-metrics-row">
                    <div class="metric-card">
                        <div class="metric-value" id="focusTimeValue">--%</div>
                        <div class="metric-label" id="focusTimeLabel">Focus Time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="longestFocusValue">--</div>
                        <div class="metric-label" id="longestFocusLabel">Longest Focus</div>
                        <div class="metric-detail" id="longestFocusDetail"></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="longestNoBreakValue">--</div>
                        <div class="metric-label">Longest w/o Break</div>
                        <div class="metric-detail" id="longestNoBreakDetail"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="timeline-section" id="timelineSection">
            <div class="section-header">
                <span class="section-title" id="timelineTitle">Activity Timeline</span>
            </div>
            <div class="timeline-container" id="timelineContainer">
                <!-- Timeline bars will be inserted here -->
            </div>
            <div class="timeline-hours" id="timelineHours">
                <!-- Hour markers will be inserted here -->
            </div>
            <div class="timeline-legend" id="timelineLegend">
                <!-- Legend items will be inserted here -->
            </div>
            <div class="timeline-hint" id="timelineHint">Click any block to see screenshots from that period</div>
        </div>

        <!-- Tag Breakdown -->
        <div class="breakdown-section" id="breakdownSection">
            <div class="section-header">
                <span class="section-title">Activity Breakdown</span>
            </div>
            <div class="tag-list" id="tagList">
                <!-- Tag items will be inserted here -->
            </div>
        </div>

        <!-- Screenshots -->
        <div class="screenshots-section" id="screenshotsSection">
            <div class="section-header">
                <span class="section-title">Key Screenshots</span>
                <a href="#" class="view-all-link" id="viewAllScreenshots">View All &rarr;</a>
            </div>
            <div class="screenshot-grid" id="screenshotGrid">
                <!-- Screenshot cards will be inserted here -->
            </div>
        </div>

        <!-- AI Summary (Collapsible) -->
        <div class="summary-section" id="summarySection">
            <button class="summary-toggle" id="summaryToggle">
                <span>AI Summary</span>
                <span class="toggle-icon">&#9660;</span>
            </button>
            <div class="summary-content" id="summaryContent">
                <div class="summary-text" id="summaryText">
                    <!-- Summary text will be inserted here -->
                </div>
                <div class="summary-meta">
                    <div class="confidence-badge">
                        <span>Confidence:</span>
                        <div class="confidence-dots" id="confidenceDots">
                            <!-- Dots will be inserted here -->
                        </div>
                    </div>
                    <div class="summary-actions">
                        <button id="regenerateSummary">Regenerate</button>
                        <button id="viewSummaryDetails">Details</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>Loading report...</div>
        </div>
    </div>

    <!-- Screenshot Modal -->
    <div class="modal-overlay" id="screenshotModal">
        <button class="modal-close" id="modalClose">&times;</button>
        <div class="modal-content">
            <img id="modalImage" src="" alt="Screenshot">
            <div class="modal-meta" id="modalMeta"></div>
        </div>
    </div>

    <script>
        // State
        let currentGranularity = 'day';
        let currentDate = new Date();
        let reportData = null;

        // DOM Elements
        const granularityBtns = document.querySelectorAll('.granularity-toggle button');
        const prevDateBtn = document.getElementById('prevDate');
        const nextDateBtn = document.getElementById('nextDate');
        const currentDateEl = document.getElementById('currentDate');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const exportBtn = document.getElementById('exportBtn');
        const exportMenu = document.getElementById('exportMenu');
        const summaryToggle = document.getElementById('summaryToggle');
        const summaryContent = document.getElementById('summaryContent');
        const screenshotModal = document.getElementById('screenshotModal');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial date from URL or today
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');
            if (dateParam) {
                currentDate = new Date(dateParam + 'T00:00:00');
            } else {
                currentDate = new Date();
            }

            updateDateDisplay();
            loadReport();

            // Event listeners
            granularityBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    setGranularity(btn.dataset.granularity);
                });
            });

            prevDateBtn.addEventListener('click', () => navigateDate(-1));
            nextDateBtn.addEventListener('click', () => navigateDate(1));

            exportBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                exportMenu.classList.toggle('visible');
            });

            document.addEventListener('click', () => {
                exportMenu.classList.remove('visible');
            });

            exportMenu.querySelectorAll('.export-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    exportReport(item.dataset.format);
                });
            });

            summaryToggle.addEventListener('click', () => {
                summaryToggle.classList.toggle('expanded');
                summaryContent.classList.toggle('visible');
            });

            document.getElementById('modalClose').addEventListener('click', () => {
                screenshotModal.classList.remove('visible');
            });

            screenshotModal.addEventListener('click', (e) => {
                if (e.target === screenshotModal) {
                    screenshotModal.classList.remove('visible');
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return;

                switch(e.key) {
                    case 'j':
                    case 'ArrowLeft':
                        navigateDate(-1);
                        break;
                    case 'k':
                    case 'ArrowRight':
                        navigateDate(1);
                        break;
                    case 'Escape':
                        screenshotModal.classList.remove('visible');
                        exportMenu.classList.remove('visible');
                        break;
                }
            });
        });

        function setGranularity(granularity) {
            currentGranularity = granularity;
            granularityBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.granularity === granularity);
            });

            if (granularity === 'custom') {
                // TODO: Show date range picker
                showToast('Custom date range coming soon', 'info');
                return;
            }

            updateDateDisplay();
            loadReport();
        }

        function navigateDate(delta) {
            switch(currentGranularity) {
                case 'day':
                    currentDate.setDate(currentDate.getDate() + delta);
                    break;
                case 'week':
                    currentDate.setDate(currentDate.getDate() + (delta * 7));
                    break;
                case 'month':
                    currentDate.setMonth(currentDate.getMonth() + delta);
                    break;
                case 'year':
                    currentDate.setFullYear(currentDate.getFullYear() + delta);
                    break;
            }

            updateDateDisplay();
            loadReport();
        }

        function updateDateDisplay() {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };

            switch(currentGranularity) {
                case 'day':
                    currentDateEl.textContent = currentDate.toLocaleDateString('en-US', options);
                    break;
                case 'week':
                    const weekStart = new Date(currentDate);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    currentDateEl.textContent = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                    break;
                case 'month':
                    currentDateEl.textContent = currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    break;
                case 'year':
                    currentDateEl.textContent = currentDate.getFullYear().toString();
                    break;
            }
        }

        function getTimeRangeString() {
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');

            switch(currentGranularity) {
                case 'day':
                    return `${year}-${month}-${day}`;
                case 'week': {
                    // Calculate week start (Sunday) and end (Saturday)
                    const weekStart = new Date(currentDate);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    return formatDateRange(weekStart, weekEnd);
                }
                case 'month': {
                    // Calculate month start and end
                    const monthStart = new Date(year, currentDate.getMonth(), 1);
                    const monthEnd = new Date(year, currentDate.getMonth() + 1, 0);
                    return formatDateRange(monthStart, monthEnd);
                }
                case 'year': {
                    // Calculate year start and end
                    const yearStart = new Date(year, 0, 1);
                    const yearEnd = new Date(year, 11, 31);
                    return formatDateRange(yearStart, yearEnd);
                }
                default:
                    return `${year}-${month}-${day}`;
            }
        }

        function formatDateRange(start, end) {
            const startStr = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}-${String(start.getDate()).padStart(2, '0')}`;
            const endStr = `${end.getFullYear()}-${String(end.getMonth() + 1).padStart(2, '0')}-${String(end.getDate()).padStart(2, '0')}`;
            return `${startStr} to ${endStr}`;
        }

        async function loadReport() {
            // Don't block the UI - load data in background
            // Show loading state in specific sections
            document.getElementById('totalTime').textContent = '...';

            try {
                // First: Fast load (skip AI summary for instant results)
                const response = await fetch('/api/reports/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        time_range: getTimeRangeString(),
                        report_type: 'summary',
                        include_screenshots: true,
                        max_screenshots: 10,
                        skip_ai_summary: true  // Fast mode!
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to load report');
                }

                reportData = await response.json();
                renderReport(reportData);

                // Show that AI summary is loading separately
                if (!reportData.executive_summary) {
                    document.getElementById('summaryText').innerHTML =
                        '<span style="color:var(--muted)">AI summary loading in background...</span>';
                }

            } catch (error) {
                console.error('Error loading report:', error);
                showToast(error.message, 'error');
            }
        }

        function renderReport(data) {
            // Hero metrics
            renderHeroMetrics(data);

            // Timeline
            renderTimeline(data);

            // Tag breakdown
            renderTagBreakdown(data);

            // Screenshots
            renderScreenshots(data);

            // AI Summary
            renderSummary(data);
        }

        function renderHeroMetrics(data) {
            const dashboard = data.dashboard || {};
            const workBreak = dashboard.work_break_balance || {};
            const meetings = dashboard.meetings || {};

            // Get raw values
            const activeSeconds = workBreak.active_seconds || 0;
            const meetingsSeconds = meetings.meetings_seconds || 0;
            const breakSeconds = workBreak.break_seconds || 0;

            // Calculate derived values
            // Total = Active + Breaks (full office time)
            const totalTracked = activeSeconds + breakSeconds;
            // Work = Active - Meetings
            const workSeconds = Math.max(0, activeSeconds - meetingsSeconds);

            // Check if we need averages (week/month/year)
            const isMultiDay = ['week', 'month', 'year'].includes(currentGranularity);
            const daysInRange = getDaysInRange();

            // Calculate averages for multi-day views
            const avgTotal = isMultiDay && daysInRange > 0 ? totalTracked / daysInRange : totalTracked;
            const avgWork = isMultiDay && daysInRange > 0 ? workSeconds / daysInRange : workSeconds;
            const avgMeetings = isMultiDay && daysInRange > 0 ? meetingsSeconds / daysInRange : meetingsSeconds;
            const avgBreaks = isMultiDay && daysInRange > 0 ? breakSeconds / daysInRange : breakSeconds;

            // Display values (use averages for multi-day)
            const displayTotal = isMultiDay ? avgTotal : totalTracked;
            const displayWork = isMultiDay ? avgWork : workSeconds;
            const displayMeetings = isMultiDay ? avgMeetings : meetingsSeconds;
            const displayBreaks = isMultiDay ? avgBreaks : breakSeconds;

            // Update main total display
            document.getElementById('totalTime').textContent = formatDuration(displayTotal);

            // Update label based on granularity
            const labels = {
                'day': 'Tracked Today',
                'week': 'Avg Daily Time',
                'month': 'Avg Daily Time',
                'year': 'Avg Daily Time'
            };
            document.getElementById('totalTimeLabel').textContent = labels[currentGranularity] || 'Total Tracked';

            // Update breakdown header
            const breakdownHeaders = {
                'day': 'TIME BREAKDOWN',
                'week': 'AVG DAILY BREAKDOWN',
                'month': 'AVG DAILY BREAKDOWN',
                'year': 'AVG DAILY BREAKDOWN'
            };
            document.getElementById('breakdownHeader').textContent = breakdownHeaders[currentGranularity] || 'TIME BREAKDOWN';

            // Update Time Breakdown bars (Work + Meetings + Breaks = Total)
            const barTotal = displayWork + displayMeetings + displayBreaks;
            document.getElementById('workBar').style.width =
                barTotal > 0 ? `${(displayWork / barTotal) * 100}%` : '0%';
            document.getElementById('meetingsBar').style.width =
                barTotal > 0 ? `${(displayMeetings / barTotal) * 100}%` : '0%';
            document.getElementById('breaksBar').style.width =
                barTotal > 0 ? `${(displayBreaks / barTotal) * 100}%` : '0%';

            // Update bar values
            document.getElementById('workValue').textContent = formatDuration(displayWork);
            document.getElementById('meetingsValue').textContent = formatDuration(displayMeetings);
            document.getElementById('breaksValue').textContent = formatDuration(displayBreaks);

            // Secondary metrics
            // 1. Focus Time %
            const deepWork = dashboard.deep_work_percentage || 0;
            document.getElementById('focusTimeValue').textContent = `${Math.round(deepWork)}%`;
            document.getElementById('focusTimeLabel').textContent = isMultiDay ? 'Avg Focus' : 'Focus Time';

            // 2. Longest Focus
            const streak = dashboard.longest_streak || {};
            const streakSeconds = streak.duration_seconds || 0;
            document.getElementById('longestFocusValue').textContent = formatDuration(streakSeconds);
            document.getElementById('longestFocusLabel').textContent = isMultiDay ? 'Best Focus' : 'Longest Focus';

            if (streak.start_time && streak.end_time) {
                const start = new Date(streak.start_time);
                const end = new Date(streak.end_time);
                if (isMultiDay) {
                    // For multi-day, show the date
                    document.getElementById('longestFocusDetail').textContent =
                        start.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                } else {
                    // For single day, show the time range
                    document.getElementById('longestFocusDetail').textContent =
                        `${start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })} - ${end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
                }
            } else {
                document.getElementById('longestFocusDetail').textContent = '';
            }

            // 3. Longest Without Break
            const longestNoBreak = workBreak.longest_work_without_break_seconds || 0;
            document.getElementById('longestNoBreakValue').textContent = formatDuration(longestNoBreak);
            document.getElementById('longestNoBreakDetail').textContent = isMultiDay ? 'this period' : 'continuous work';
        }

        // Helper to calculate days in current range based on granularity
        function getDaysInRange() {
            switch (currentGranularity) {
                case 'day': return 1;
                case 'week': return 7;
                case 'month': {
                    // Days in the current month
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    return new Date(year, month + 1, 0).getDate();
                }
                case 'year': {
                    // Days in the current year
                    const year = currentDate.getFullYear();
                    const isLeap = (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
                    return isLeap ? 366 : 365;
                }
                default: return 1;
            }
        }

        function renderTimeline(data) {
            const container = document.getElementById('timelineContainer');
            const hoursEl = document.getElementById('timelineHours');
            const legendEl = document.getElementById('timelineLegend');
            const titleEl = document.getElementById('timelineTitle');
            const hintEl = document.getElementById('timelineHint');
            const dashboard = data.dashboard || {};
            const events = dashboard.timeline_events || [];

            container.innerHTML = '';
            container.classList.remove('vertical-bars'); // Reset layout

            // Update title and hint based on granularity
            const titles = {
                'day': 'Hourly Activity',
                'week': 'Daily Activity',
                'month': 'Daily Activity',
                'year': 'Monthly Activity'
            };
            const hints = {
                'day': 'Hover for details',
                'week': 'Bar height shows relative activity per day',
                'month': 'Bar height shows relative activity per day',
                'year': 'Bar height shows relative activity per month'
            };
            titleEl.textContent = titles[currentGranularity] || 'Activity Timeline';
            hintEl.textContent = hints[currentGranularity] || '';

            if (events.length === 0) {
                container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);">No activity data</div>';
                return;
            }

            const startTime = new Date(data.start_time);
            const endTime = new Date(data.end_time);

            // Determine timeline mode based on granularity
            if (currentGranularity === 'day') {
                renderHourlyTimeline(container, hoursEl, events, dashboard);
            } else if (currentGranularity === 'week' || currentGranularity === 'month') {
                renderDailyTimeline(container, hoursEl, events, dashboard, startTime, endTime);
            } else if (currentGranularity === 'year') {
                renderMonthlyTimeline(container, hoursEl, events, dashboard, startTime, endTime);
            }

            // Render legend (common to all views)
            const tagColors = dashboard.tag_colors || {};
            const usedTags = [...new Set(events.map(e => e.tag))];

            legendEl.innerHTML = '';
            usedTags.forEach(tag => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <span class="legend-color" style="background:${tagColors[tag] || '#666'}"></span>
                    <span>${tag}</span>
                `;
                legendEl.appendChild(item);
            });
        }

        function renderHourlyTimeline(container, hoursEl, events, dashboard) {
            // Find time range for the day
            let minHour = 24, maxHour = 0;

            events.forEach(event => {
                const start = new Date(event.start_time);
                const end = new Date(event.end_time);
                minHour = Math.min(minHour, start.getHours());
                maxHour = Math.max(maxHour, end.getHours() + 1);
            });

            minHour = Math.max(0, minHour - 1);
            maxHour = Math.min(24, maxHour + 1);
            const totalHours = maxHour - minHour;

            // Render events as hourly bars
            events.forEach(event => {
                const start = new Date(event.start_time);
                const end = new Date(event.end_time);

                const startHour = start.getHours() + start.getMinutes() / 60;
                const endHour = end.getHours() + end.getMinutes() / 60;

                const left = ((startHour - minHour) / totalHours) * 100;
                const width = ((endHour - startHour) / totalHours) * 100;

                const bar = document.createElement('div');
                bar.className = 'timeline-bar';
                bar.style.left = `${left}%`;
                bar.style.width = `${Math.max(width, 0.5)}%`;
                bar.style.backgroundColor = event.color || 'var(--accent)';
                bar.title = `${event.tag}\n${event.window_title || event.app_name}\n${formatDuration(event.duration_seconds)}`;

                if (width > 5) {
                    const label = document.createElement('span');
                    label.className = 'bar-label';
                    label.textContent = event.tag.replace('#', '');
                    bar.appendChild(label);
                }

                container.appendChild(bar);
            });

            // Render hour markers
            hoursEl.innerHTML = '';
            for (let h = minHour; h <= maxHour; h += 2) {
                const span = document.createElement('span');
                span.textContent = h === 0 ? '12am' : h === 12 ? '12pm' : h > 12 ? `${h-12}pm` : `${h}am`;
                hoursEl.appendChild(span);
            }
        }

        function renderDailyTimeline(container, hoursEl, events, dashboard, startTime, endTime) {
            // For month view, aggregate by week instead of day to avoid squished bars
            if (currentGranularity === 'month') {
                renderWeeklyAggregatedTimeline(container, hoursEl, events, dashboard, startTime, endTime);
                return;
            }

            // Week view: Show daily bars (7 bars)
            const dailyData = {};

            events.forEach(event => {
                const eventDate = new Date(event.start_time);
                const dateKey = eventDate.toISOString().split('T')[0];

                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = { total: 0, byTag: {} };
                }

                dailyData[dateKey].total += event.duration_seconds || 0;

                const tag = event.tag || '#other';
                if (!dailyData[dateKey].byTag[tag]) {
                    dailyData[dateKey].byTag[tag] = { seconds: 0, color: event.color };
                }
                dailyData[dateKey].byTag[tag].seconds += event.duration_seconds || 0;
            });

            // Generate all days in the range
            const days = [];
            const current = new Date(startTime);
            current.setHours(0, 0, 0, 0);
            const endDate = new Date(endTime);
            endDate.setHours(23, 59, 59, 999);

            while (current <= endDate) {
                days.push(current.toISOString().split('T')[0]);
                current.setDate(current.getDate() + 1);
            }

            // Find max for scaling
            const maxDayTotal = Math.max(...Object.values(dailyData).map(d => d.total), 1);

            // Use flexbox layout for week view (better spacing)
            container.classList.add('vertical-bars');

            days.forEach((dateKey, index) => {
                const dayData = dailyData[dateKey];
                const date = new Date(dateKey + 'T00:00:00');
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

                // Create bar container
                const barContainer = document.createElement('div');
                barContainer.className = 'vertical-bar-container';

                // Create the bar
                const barWrapper = document.createElement('div');
                barWrapper.className = 'vertical-bar-wrapper';

                if (!dayData || dayData.total === 0) {
                    const bar = document.createElement('div');
                    bar.className = 'vertical-bar empty';
                    bar.title = `${dayNames[date.getDay()]}\nNo activity`;
                    barWrapper.appendChild(bar);
                } else {
                    const heightPercent = (dayData.total / maxDayTotal) * 100;

                    // Create stacked segments
                    const sortedTags = Object.entries(dayData.byTag)
                        .sort((a, b) => b[1].seconds - a[1].seconds);

                    sortedTags.forEach(([tag, { seconds, color }]) => {
                        const segmentHeight = (seconds / dayData.total) * heightPercent;
                        const segment = document.createElement('div');
                        segment.className = 'vertical-bar-segment';
                        segment.style.height = `${segmentHeight}%`;
                        segment.style.backgroundColor = color || 'var(--accent)';
                        segment.title = `${dayNames[date.getDay()]}\n${tag}: ${formatDuration(seconds)}\nTotal: ${formatDuration(dayData.total)}`;
                        barWrapper.appendChild(segment);
                    });
                }

                // Label
                const label = document.createElement('div');
                label.className = 'vertical-bar-label';
                label.textContent = dayNames[date.getDay()];

                barContainer.appendChild(barWrapper);
                barContainer.appendChild(label);
                container.appendChild(barContainer);
            });

            // Clear hour markers (we use labels below bars instead)
            hoursEl.innerHTML = '';
        }

        function renderWeeklyAggregatedTimeline(container, hoursEl, events, dashboard, startTime, endTime) {
            // Aggregate events by week for month view
            const weeklyData = {};

            events.forEach(event => {
                const eventDate = new Date(event.start_time);
                // Get week number (ISO week)
                const weekStart = getWeekStart(eventDate);
                const weekKey = weekStart.toISOString().split('T')[0];

                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = { total: 0, byTag: {}, weekStart: weekStart };
                }

                weeklyData[weekKey].total += event.duration_seconds || 0;

                const tag = event.tag || '#other';
                if (!weeklyData[weekKey].byTag[tag]) {
                    weeklyData[weekKey].byTag[tag] = { seconds: 0, color: event.color };
                }
                weeklyData[weekKey].byTag[tag].seconds += event.duration_seconds || 0;
            });

            // Generate all weeks in the range
            const weeks = [];
            const current = getWeekStart(new Date(startTime));
            const endWeek = getWeekStart(new Date(endTime));

            while (current <= endWeek) {
                weeks.push(current.toISOString().split('T')[0]);
                current.setDate(current.getDate() + 7);
            }

            // Find max for scaling
            const maxWeekTotal = Math.max(...Object.values(weeklyData).map(d => d.total), 1);

            // Use flexbox layout
            container.classList.add('vertical-bars');

            weeks.forEach((weekKey, index) => {
                const weekData = weeklyData[weekKey];
                const weekStart = new Date(weekKey + 'T00:00:00');
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                // Create bar container
                const barContainer = document.createElement('div');
                barContainer.className = 'vertical-bar-container';

                // Create the bar
                const barWrapper = document.createElement('div');
                barWrapper.className = 'vertical-bar-wrapper';

                if (!weekData || weekData.total === 0) {
                    const bar = document.createElement('div');
                    bar.className = 'vertical-bar empty';
                    bar.title = `Week of ${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}\nNo activity`;
                    barWrapper.appendChild(bar);
                } else {
                    const heightPercent = (weekData.total / maxWeekTotal) * 100;

                    const sortedTags = Object.entries(weekData.byTag)
                        .sort((a, b) => b[1].seconds - a[1].seconds);

                    sortedTags.forEach(([tag, { seconds, color }]) => {
                        const segmentHeight = (seconds / weekData.total) * heightPercent;
                        const segment = document.createElement('div');
                        segment.className = 'vertical-bar-segment';
                        segment.style.height = `${segmentHeight}%`;
                        segment.style.backgroundColor = color || 'var(--accent)';
                        segment.title = `Week ${index + 1}\n${tag}: ${formatDuration(seconds)}\nTotal: ${formatDuration(weekData.total)}`;
                        barWrapper.appendChild(segment);
                    });
                }

                // Label (show date range)
                const label = document.createElement('div');
                label.className = 'vertical-bar-label';
                label.textContent = `${weekStart.getMonth() + 1}/${weekStart.getDate()}`;

                barContainer.appendChild(barWrapper);
                barContainer.appendChild(label);
                container.appendChild(barContainer);
            });

            // Clear hour markers
            hoursEl.innerHTML = '';
        }

        // Helper: Get Monday of the week containing the date
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
            return new Date(d.setDate(diff));
        }

        function renderMonthlyTimeline(container, hoursEl, events, dashboard, startTime, endTime) {
            // Aggregate events by month
            const monthlyData = {};
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            events.forEach(event => {
                const eventDate = new Date(event.start_time);
                const monthKey = `${eventDate.getFullYear()}-${String(eventDate.getMonth() + 1).padStart(2, '0')}`;

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { total: 0, byTag: {} };
                }

                monthlyData[monthKey].total += event.duration_seconds || 0;

                const tag = event.tag || '#other';
                if (!monthlyData[monthKey].byTag[tag]) {
                    monthlyData[monthKey].byTag[tag] = { seconds: 0, color: event.color };
                }
                monthlyData[monthKey].byTag[tag].seconds += event.duration_seconds || 0;
            });

            // Generate all months in the range
            const months = [];
            const current = new Date(startTime.getFullYear(), startTime.getMonth(), 1);
            const endMonth = new Date(endTime.getFullYear(), endTime.getMonth(), 1);

            while (current <= endMonth) {
                months.push(`${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`);
                current.setMonth(current.getMonth() + 1);
            }

            // Find max for scaling
            const maxMonthTotal = Math.max(...Object.values(monthlyData).map(d => d.total), 1);

            // Use vertical bar layout
            container.classList.add('vertical-bars');

            months.forEach((monthKey, index) => {
                const monthData = monthlyData[monthKey];
                const [year, month] = monthKey.split('-');
                const monthName = monthNames[parseInt(month) - 1];

                // Create bar container
                const barContainer = document.createElement('div');
                barContainer.className = 'vertical-bar-container';

                // Create the bar
                const barWrapper = document.createElement('div');
                barWrapper.className = 'vertical-bar-wrapper';

                if (!monthData || monthData.total === 0) {
                    const bar = document.createElement('div');
                    bar.className = 'vertical-bar empty';
                    bar.title = `${monthName} ${year}\nNo activity`;
                    barWrapper.appendChild(bar);
                } else {
                    const heightPercent = (monthData.total / maxMonthTotal) * 100;

                    const sortedTags = Object.entries(monthData.byTag)
                        .sort((a, b) => b[1].seconds - a[1].seconds);

                    sortedTags.forEach(([tag, { seconds, color }]) => {
                        const segmentHeight = (seconds / monthData.total) * heightPercent;
                        const segment = document.createElement('div');
                        segment.className = 'vertical-bar-segment';
                        segment.style.height = `${segmentHeight}%`;
                        segment.style.backgroundColor = color || 'var(--accent)';
                        segment.title = `${monthName} ${year}\n${tag}: ${formatDuration(seconds)}\nTotal: ${formatDuration(monthData.total)}`;
                        barWrapper.appendChild(segment);
                    });
                }

                // Label
                const label = document.createElement('div');
                label.className = 'vertical-bar-label';
                label.textContent = monthName;

                barContainer.appendChild(barWrapper);
                barContainer.appendChild(label);
                container.appendChild(barContainer);
            });

            // Clear hour markers (we use labels below bars instead)
            hoursEl.innerHTML = '';
        }

        function renderTagBreakdown(data) {
            const container = document.getElementById('tagList');
            const dashboard = data.dashboard || {};
            const breakdown = dashboard.tag_breakdown || [];

            container.innerHTML = '';

            if (breakdown.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">No activity data</div></div>';
                return;
            }

            breakdown.forEach(tag => {
                const item = document.createElement('div');
                item.className = 'tag-item';

                const windowsHtml = (tag.windows || []).slice(0, 5).map(w => `
                    <div class="window-item">
                        <span class="window-title" title="${escapeHtml(w.window_title)}">${escapeHtml(w.window_title || w.app_name)}</span>
                        <span class="window-duration">${formatDuration(w.duration_seconds)}</span>
                    </div>
                `).join('');

                item.innerHTML = `
                    <div class="tag-header">
                        <span class="tag-name">
                            <span class="tag-dot" style="background:${tag.color}"></span>
                            ${tag.tag}
                        </span>
                        <div class="tag-stats">
                            <span class="tag-duration">${formatDuration(tag.total_seconds)}</span>
                            <span class="tag-percentage">${tag.percentage}%</span>
                        </div>
                    </div>
                    <div class="tag-progress">
                        <div class="tag-progress-fill" style="width:${tag.percentage}%;background:${tag.color}"></div>
                    </div>
                    <div class="tag-windows">${windowsHtml}</div>
                `;

                container.appendChild(item);
            });
        }

        function renderScreenshots(data) {
            const container = document.getElementById('screenshotGrid');
            const screenshots = data.key_screenshots || [];

            container.innerHTML = '';

            if (screenshots.length === 0) {
                container.innerHTML = '<div style="color:var(--muted);padding:20px;">No screenshots available</div>';
                return;
            }

            screenshots.forEach(screenshot => {
                const card = document.createElement('div');
                card.className = 'screenshot-card';

                const time = new Date(screenshot.timestamp);
                const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                card.innerHTML = `
                    <div class="screenshot-thumb">
                        <img src="/thumbnail/${screenshot.id}" alt="Screenshot" loading="lazy">
                    </div>
                    <div class="screenshot-meta">
                        <div class="screenshot-time">${timeStr}</div>
                        <div class="screenshot-tag">${screenshot.tag || ''}</div>
                    </div>
                `;

                card.addEventListener('click', () => {
                    document.getElementById('modalImage').src = screenshot.url;
                    document.getElementById('modalMeta').textContent = `${timeStr} - ${screenshot.window_title || ''}`;
                    screenshotModal.classList.add('visible');
                });

                container.appendChild(card);
            });
        }

        function renderSummary(data) {
            const summaryText = document.getElementById('summaryText');
            const confidenceDots = document.getElementById('confidenceDots');

            const summary = data.executive_summary || 'No AI summary available for this period.';
            summaryText.textContent = summary;

            // Render confidence dots (assuming 85% = 4 out of 5 dots)
            const confidence = 0.85; // TODO: Get from data
            confidenceDots.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const dot = document.createElement('span');
                dot.className = 'confidence-dot' + (i < Math.round(confidence * 5) ? ' filled' : '');
                confidenceDots.appendChild(dot);
            }
        }

        async function exportReport(format) {
            if (!reportData) {
                showToast('No report data to export', 'error');
                return;
            }

            try {
                const response = await fetch('/api/reports/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        report: reportData,
                        format: format
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Export failed');
                }

                const result = await response.json();

                if (format === 'html') {
                    window.open(result.download_url, '_blank');
                } else {
                    const a = document.createElement('a');
                    a.href = result.download_url;
                    a.download = result.filename;
                    a.click();
                }

                showToast(`Exported as ${format.toUpperCase()}`, 'success');

            } catch (error) {
                console.error('Export error:', error);
                showToast(error.message, 'error');
            }
        }

        // Utility functions
        function formatDuration(seconds) {
            if (!seconds || seconds < 0) return '0m';

            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);

            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, char => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[char]);
        }

        function showToast(message, type = 'info') {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--accent)'};
                color: white;
                border-radius: 8px;
                font-size: 0.875rem;
                z-index: 1001;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
